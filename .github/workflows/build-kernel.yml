name: Build SM-M556B Samsung Kernel (Full Auto + Swap + FreeSpace)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_TARGET: m55xq_swa_open
      CHIPSET_NAME: x55
      DEBIAN_FRONTEND: noninteractive

    steps:
    # 1Ô∏è‚É£ LIMPEZA DE DISCO (CR√çTICO: Libera ~30GB de espa√ßo)
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        # Manter apenas o necess√°rio
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    # 2Ô∏è‚É£ Checkout
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: 1

    # 3Ô∏è‚É£ SWAP (Reduzido para 8GB para caber no disco)
    - name: Setup Swap (8GB)
      run: |
        echo "üîß Criando arquivo de Swap de 8GB..."
        # Tenta alocar 8GB. Se falhar, tenta 4GB.
        sudo fallocate -l 8G /swapfile || sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "‚úÖ Swap ativado:"
        free -h
        echo "üíæ Espa√ßo em disco restante:"
        df -h

    # 4Ô∏è‚É£ Depend√™ncias
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential cpio flex git \
          libncurses-dev libssl-dev python3 \
          unzip wget rsync dwarves lld

    # 5Ô∏è‚É£ Export vari√°veis Samsung
    - name: Export Samsung build variables
      run: |
        echo "MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "PROJECT_NAME=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "REGION=$(echo $BUILD_TARGET | cut -d'_' -f2)" >> $GITHUB_ENV
        echo "CARRIER=$(echo $BUILD_TARGET | cut -d'_' -f3)" >> $GITHUB_ENV
        echo "ANDROID_BUILD_TOP=$PWD" >> $GITHUB_ENV
        echo "TARGET_PRODUCT=gki" >> $GITHUB_ENV
        echo "TARGET_BOARD_PLATFORM=gki" >> $GITHUB_ENV
        echo "IS_KBUILD=true" >> $GITHUB_ENV

    # 6Ô∏è‚É£ Detectar estrutura real do kernel
    - name: Detect kernel structure
      run: |
        echo "üîç Detectando layout..."
        if [ -d "Kernel/kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=Kernel/kernel_platform" >> $GITHUB_ENV
        elif [ -d "kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=kernel_platform" >> $GITHUB_ENV
        else
          echo "‚ùå kernel_platform/build/android n√£o encontrado"
          exit 1
        fi

    # 7Ô∏è‚É£ Usar clang do pr√≥prio repo (Samsung)
    - name: Setup Samsung clang
      run: |
        CLANG_DIR=$(find $KERNEL_PATH -path "*clang*/bin/clang" | head -n 1 | xargs dirname)
        if [ -z "$CLANG_DIR" ]; then
          echo "‚ùå Clang n√£o encontrado no repo"
          exit 1
        fi
        echo "‚úÖ Clang encontrado em: $CLANG_DIR"
        echo "$CLANG_DIR" >> $GITHUB_PATH

    # 8Ô∏è‚É£ Build kernel (OFICIAL)
    - name: Build Samsung GKI kernel
      run: |
        cd $KERNEL_PATH
        chmod +x build/android/prepare_vendor.sh
        
        echo "üöÄ Iniciando compila√ß√£o..."
        RECOMPILE_KERNEL=1 build/android/prepare_vendor.sh $CHIPSET_NAME gki gki

    # 9Ô∏è‚É£ Empacotar (Otimizado)
    - name: Package kernel output
      run: |
        mkdir -p artifacts
        echo "üì¶ Empacotando arquivos..."
        
        # Tenta achar a pasta 'dist' que cont√©m os arquivos finais limpos
        DIST_DIR=$(find . -type d -name "dist" | grep "out" | head -n 1)
        
        if [ -n "$DIST_DIR" ]; then
            echo "‚úÖ Pasta dist encontrada: $DIST_DIR"
            cp -r $DIST_DIR/* artifacts/
        else
            echo "‚ö†Ô∏è Pasta dist n√£o encontrada. Buscando Image manualmente..."
            find . -name "Image" -exec cp {} artifacts/ \;
            find . -name "Image.lz4" -exec cp {} artifacts/ \;
            find . -name "*.dtb" -exec cp {} artifacts/ \;
            find . -name "dtbo.img" -exec cp {} artifacts/ \;
        fi

        zip -r SM-M556B_kernel_build.zip artifacts

    # üîü Upload
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M556B_kernel_build
        path: SM-M556B_kernel_build.zip
