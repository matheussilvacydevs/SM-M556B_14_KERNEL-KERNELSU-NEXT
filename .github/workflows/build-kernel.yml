name: Build SM-M556B Stock Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      O: out

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses-dev bison flex libssl-dev bc curl wget unzip cpio python3 python3-venv python3-pip git

    - name: Setup Linaro Toolchain
      run: |
        mkdir -p prebuilts
        wget -qO- https://releases.linaro.org/components/toolchain/binaries/latest-7/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz | tar -xJ -C prebuilts
        export PATH=$PWD/prebuilts/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:$PATH

    - name: Prepare build directories
      run: |
        cd Kernel/kernel_platform/common
        mkdir -p $O/usr/include/asm
        mkdir -p $O/include

    - name: Configure kernel
      run: |
        cd Kernel/kernel_platform/common
        make O=$O gki_defconfig

    - name: Compile kernel
      run: |
        cd Kernel/kernel_platform/common
        make -j$(nproc) O=$O ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- HDRINST=$O/usr/include

    - name: Package kernel
      run: |
        cd Kernel/kernel_platform/common/$O
        zip -r ../../../../SM-M556B_14_kernel_build.zip *

    - name: Upload kernel zip
      uses: actions/upload-artifact@v3
      with:
        name: SM-M556B_14_kernel_build
        path: Kernel/kernel_platform/common/SM-M556B_14_kernel_build.zip
