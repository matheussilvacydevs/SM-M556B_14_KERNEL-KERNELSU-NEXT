name: Build Kernel SM-M556B (No LTO)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential curl flex git gnupg \
            gperf libncurses-dev libssl-dev python3 \
            zip unzip zstd

      - name: Setup Clang
        run: |
          mkdir -p $HOME/clang
          curl -L https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/clang+llvm-17.0.6-x86_64-linux-gnu-ubuntu-22.04.tar.xz \
          | tar -xJ --strip-components=1 -C $HOME/clang
          echo "$HOME/clang/bin" >> $GITHUB_PATH

      - name: Export build vars
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV

      - name: Disable LTO (forced)
        run: |
          DEFCONFIG=Kernel/kernel_platform/msm-kernel/arch/arm64/configs/vendor/x55_defconfig

          echo ">> Before:"
          grep CONFIG_LTO $DEFCONFIG || true

          sed -i 's/^CONFIG_LTO=y/CONFIG_LTO=n/' $DEFCONFIG
          sed -i 's/^CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/' $DEFCONFIG
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_FULL=n/' $DEFCONFIG
          sed -i 's/^CONFIG_THINLTO=y/CONFIG_THINLTO=n/' $DEFCONFIG

          echo ">> After:"
          grep CONFIG_LTO $DEFCONFIG || true

      - name: Kernel defconfig
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make vendor/x55_defconfig

      - name: Build kernel
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make -j$(nproc)

      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: |
            Kernel/kernel_platform/msm-kernel/arch/arm64/boot/Image
            Kernel/kernel_platform/msm-kernel/arch/arm64/boot/Image.gz
            Kernel/kernel_platform/msm-kernel/arch/arm64/boot/Image.lz4
