name: Build SM-M556B Samsung Kernel (Full Auto)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_TARGET: m55xq_swa_open
      CHIPSET_NAME: x55

    steps:
    # 1Ô∏è‚É£ Checkout
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # 2Ô∏è‚É£ Git LFS (CR√çTICO)
    - name: Setup Git LFS
      run: |
        sudo apt update
        sudo apt install -y git-lfs
        git lfs install
        git lfs pull

    # 3Ô∏è‚É£ Depend√™ncias
    - name: Install build dependencies
      run: |
        sudo apt install -y \
          bc bison build-essential cpio flex git \
          libncurses-dev libssl-dev python3 \
          unzip wget rsync

    # 4Ô∏è‚É£ Export vari√°veis Samsung
    - name: Export Samsung build variables
      run: |
        echo "MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "PROJECT_NAME=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "REGION=$(echo $BUILD_TARGET | cut -d'_' -f2)" >> $GITHUB_ENV
        echo "CARRIER=$(echo $BUILD_TARGET | cut -d'_' -f3)" >> $GITHUB_ENV
        echo "ANDROID_BUILD_TOP=$PWD" >> $GITHUB_ENV
        echo "TARGET_PRODUCT=gki" >> $GITHUB_ENV
        echo "TARGET_BOARD_PLATFORM=gki" >> $GITHUB_ENV
        echo "IS_KBUILD=true" >> $GITHUB_ENV

    # 5Ô∏è‚É£ Detectar estrutura real do kernel
    - name: Detect kernel structure
      run: |
        echo "üîç Detectando layout..."
        if [ -d "Kernel/kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=Kernel/kernel_platform" >> $GITHUB_ENV
          echo "KERNEL_MODE=samsung" >> $GITHUB_ENV
        elif [ -d "kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=kernel_platform" >> $GITHUB_ENV
          echo "KERNEL_MODE=samsung" >> $GITHUB_ENV
        else
          echo "‚ùå kernel_platform/build/android n√£o encontrado"
          echo "üìÅ Estrutura do repo:"
          find . -maxdepth 4 -type d
          exit 1
        fi

    # 6Ô∏è‚É£ Usar clang do pr√≥prio repo (Samsung)
    - name: Setup Samsung clang
      run: |
        CLANG_DIR=$(find $KERNEL_PATH -path "*clang*/bin/clang" | head -n 1 | xargs dirname)
        if [ -z "$CLANG_DIR" ]; then
          echo "‚ùå Clang n√£o encontrado no repo"
          exit 1
        fi
        echo "Found clang at: $CLANG_DIR"
        echo "$CLANG_DIR" >> $GITHUB_PATH

    # 7Ô∏è‚É£ Build kernel (OFICIAL)
    - name: Build Samsung GKI kernel
      run: |
        cd $KERNEL_PATH
        chmod +x build/android/prepare_vendor.sh
        RECOMPILE_KERNEL=1 \
        build/android/prepare_vendor.sh $CHIPSET_NAME gki gki

    # 8Ô∏è‚É£ Empacotar
    - name: Package kernel output
      run: |
        mkdir -p artifacts
        find . -type d -name "msm-$CHIPSET_NAME*" -exec cp -r {} artifacts/ \;
        zip -r SM-M556B_kernel_build.zip artifacts

    # 9Ô∏è‚É£ Upload
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M556B_kernel_build
        path: SM-M556B_kernel_build.zip
