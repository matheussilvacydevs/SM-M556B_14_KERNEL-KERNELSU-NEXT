name: Build SM-M556B Kernel (FINAL / NO LTO / NO HDRINST)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      LLVM: 1
      LLVM_IAS: 1
      ANDROID_BUILD_TOP: ${{ github.workspace }}
      INSTALL_HDR_PATH: /dev/null
      SKIP_HEADERS_INSTALL: 1

    steps:
      # ===============================
      # CHECKOUT
      # ===============================
      - name: Checkout kernel
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false

      # ===============================
      # DEPENDÊNCIAS
      # ===============================
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex \
            git git-lfs \
            libssl-dev libelf-dev \
            build-essential \
            python3 \
            clang lld \
            ccache

      # ===============================
      # CCACHE
      # ===============================
      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV

      # ===============================
      # FORÇAR DESATIVAR LTO
      # ===============================
      - name: Force disable LTO
        run: |
          DEFCONFIG=Kernel/kernel_platform/msm-kernel/arch/arm64/configs/vendor/x55_defconfig

          sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_THIN=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_FULL=n/g' $DEFCONFIG || true

          grep -q CONFIG_LTO_NONE $DEFCONFIG || echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      # ===============================
      # DEFCONFIG
      # ===============================
      - name: Kernel defconfig
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make O=out vendor/x55_defconfig

      # ===============================
      # BUILD (HDRINST BLOQUEADO)
      # ===============================
      - name: Build kernel Image ONLY
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make -j$(n
