name: Build SM-M556B Samsung GKI Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_TARGET: m55xq_swa_open
      CHIPSET_NAME: x55
      TARGET_PRODUCT: gki

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential cpio flex git \
          libncurses-dev libssl-dev python3 \
          unzip wget rsync

    - name: Setup Clang toolchain (AOSP)
      run: |
        mkdir -p prebuilts/clang
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522817.tar.gz
        tar -xzf clang-r522817.tar.gz -C prebuilts/clang
        echo "$PWD/prebuilts/clang/bin" >> $GITHUB_PATH

    - name: Export Samsung build variables
      run: |
        echo "MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "PROJECT_NAME=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "REGION=$(echo $BUILD_TARGET | cut -d'_' -f2)" >> $GITHUB_ENV
        echo "CARRIER=$(echo $BUILD_TARGET | cut -d'_' -f3)" >> $GITHUB_ENV
        echo "ANDROID_BUILD_TOP=$PWD" >> $GITHUB_ENV
        echo "TARGET_BOARD_PLATFORM=gki" >> $GITHUB_ENV
        echo "TARGET_PRODUCT=gki" >> $GITHUB_ENV
        echo "IS_KBUILD=true" >> $GITHUB_ENV
        echo "OUT_DIR=$PWD/out/msm-$CHIPSET_NAME-$CHIPSET_NAME-gki" >> $GITHUB_ENV

    - name: Build Samsung GKI Kernel (official way)
      run: |
        cd kernel_platform
        chmod +x build/android/prepare_vendor.sh
        RECOMPILE_KERNEL=1 \
        build/android/prepare_vendor.sh $CHIPSET_NAME gki gki

    - name: Package kernel output
      run: |
        cd out
        zip -r SM-M556B_GKI_kernel.zip msm-$CHIPSET_NAME-$CHIPSET_NAME-gki

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M556B_GKI_kernel
        path: out/SM-M556B_GKI_kernel.zip
