name: Build SM-M556B Kernel (Safe / No LTO / No Submodules)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      LLVM: 1
      LLVM_IAS: 1
      ANDROID_BUILD_TOP: ${{ github.workspace }}

    steps:
      # ===============================
      # CHECKOUT (SEM SUBMODULES)
      # ===============================
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false

      # ===============================
      # DEPENDÊNCIAS
      # ===============================
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex git git-lfs \
            libssl-dev libelf-dev \
            build-essential \
            python3 \
            ccache \
            clang lld

      # ===============================
      # LIMPAR SUBMODULES (FIX SAMSUNG)
      # ===============================
      - name: Disable Samsung submodules
        run: |
          rm -f .gitmodules || true
          git config --remove-section submodule || true

      # ===============================
      # SETUP CCACHE (REDUZ OOM)
      # ===============================
      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV

      # ===============================
      # DESATIVAR LTO (FORÇADO)
      # ===============================
      - name: Force disable LTO (Vega method)
        run: |
          DEFCONFIG=Kernel/kernel_platform/msm-kernel/arch/arm64/configs/vendor/x55_defconfig

          sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_THIN=n/g' $DEFCONFIG || true
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_FULL=n/g' $DEFCONFIG || true

          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      # ===============================
      # DEFCONFIG
      # ===============================
      - name: Kernel defconfig
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make O=out vendor/x55_defconfig

      # ===============================
      # BUILD (SEM HDRINST / SEM OOM)
      # ===============================
      - name: Build kernel Image
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make -j$(nproc --ignore=1) \
            O=out \
            CC="ccache clang" \
            LD=ld.lld \
            Image

      # ===============================
      # VERIFICAÇÃO
      # ===============================
      - name: Verify Image
        run: |
          ls -lh Kernel/kernel_platform/msm-kernel/out/arch/arm64/boot/Image

      # ===============================
      # UPLOAD
      # ===============================
      - name: Upload kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: SM-M556B-Image
          path: Kernel/kernel_platform/msm-kernel/out/arch/arm64/boot/Image
