name: Build SM-M556B Samsung Kernel (No LTO)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_TARGET: m55xq_swa_open
      CHIPSET_NAME: x55

    steps:
    # 1️⃣ Checkout (com LFS)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # 2️⃣ Git LFS (CRÍTICO)
    - name: Setup Git LFS
      run: |
        sudo apt update
        sudo apt install -y git-lfs
        git lfs install
        git lfs pull

    # 3️⃣ Dependências
    - name: Install build dependencies
      run: |
        sudo apt install -y \
          bc bison build-essential cpio flex git \
          libncurses-dev libssl-dev python3 \
          unzip wget rsync

    # 4️⃣ Export variáveis Samsung
    - name: Export Samsung build variables
      run: |
        echo "MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "PROJECT_NAME=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "REGION=$(echo $BUILD_TARGET | cut -d'_' -f2)" >> $GITHUB_ENV
        echo "CARRIER=$(echo $BUILD_TARGET | cut -d'_' -f3)" >> $GITHUB_ENV
        echo "ANDROID_BUILD_TOP=$PWD" >> $GITHUB_ENV
        echo "TARGET_PRODUCT=gki" >> $GITHUB_ENV
        echo "TARGET_BOARD_PLATFORM=gki" >> $GITHUB_ENV
        echo "IS_KBUILD=true" >> $GITHUB_ENV

    # 5️⃣ Detectar estrutura do kernel
    - name: Detect kernel structure
      run: |
        if [ -d "Kernel/kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=Kernel/kernel_platform" >> $GITHUB_ENV
        elif [ -d "kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=kernel_platform" >> $GITHUB_ENV
        else
          echo "❌ kernel_platform/build/android não encontrado"
          find . -maxdepth 4 -type d
          exit 1
        fi

    # 6️⃣ Usar clang do próprio repo (Samsung)
    - name: Setup Samsung clang
      run: |
        CLANG_BIN=$(find $KERNEL_PATH -path "*clang*/bin/clang" | head -n 1)
        if [ -z "$CLANG_BIN" ]; then
          echo "❌ clang não encontrado no repo"
          exit 1
        fi
        echo "Clang encontrado em: $CLANG_BIN"
        echo "$(dirname $CLANG_BIN)" >> $GITHUB_PATH

    # 7️⃣ Build kernel (LTO OFF + low memory)
    - name: Build Samsung GKI kernel (NO LTO)
      run: |
        cd $KERNEL_PATH
        chmod +x build/android/prepare_vendor.sh

        export LLVM=1
        export LLVM_IAS=1
        export LLVM_LTO=none
        export KCFLAGS="-Wno-error"
        export KBUILD_BUILD_USER=ci
        export KBUILD_BUILD_HOST=github

        RECOMPILE_KERNEL=1 \
        MAKEFLAGS="-j2" \
        build/android/prepare_vendor.sh $CHIPSET_NAME gki gki

    # 8️⃣ Empacotar saída
    - name: Package kernel output
      run: |
        mkdir -p artifacts
        find . -type d -name "msm-$CHIPSET_NAME*" -exec cp -r {} artifacts/ \;
        zip -r SM-M556B_kernel_build.zip artifacts

    # 9️⃣ Upload
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M556B_kernel_build
        path: SM-M556B_kernel_build.zip
