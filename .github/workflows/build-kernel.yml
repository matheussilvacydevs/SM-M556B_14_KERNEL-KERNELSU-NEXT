name: Build Kernel SM-M556B (KernelSU Next)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CLANG_PATH: clang
      CC: clang
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_ARM32: arm-linux-gnueabi-

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Swap (IMPORTANT)
      run: |
        sudo fallocate -l 12G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential \
          clang flex git \
          libssl-dev \
          llvm lld \
          python3 \
          cpio \
          unzip \
          rsync

    - name: Setup Clang Toolchain
      run: |
        git clone --depth=1 https://github.com/llvm/llvm-project.git clang
        echo "PATH=$PWD/clang/build/bin:$PATH" >> $GITHUB_ENV

    - name: Clone KernelSU Next
      run: |
        git clone https://github.com/KernelSU-Next/KernelSU-Next.git
        cd KernelSU-Next
        export KERNELSU_NEXT=1
        ./kernel/setup.sh

    - name: Kernel Config
      run: |
        cd Kernel/kernel_platform/common
        make O=out vendor/gki_defconfig

        # ðŸ”¥ DESATIVA LTO (causa do crash)
        scripts/config --file out/.config \
          -d LTO \
          -d LTO_CLANG \
          -d THINLTO

        # KernelSU
        scripts/config --file out/.config \
          -e CONFIG_KSU \
          -e CONFIG_KSU_SUSFS

        make O=out olddefconfig

    - name: Build Kernel
      run: |
        cd Kernel/kernel_platform/common
        make O=out \
          CC=clang \
          LD=ld.lld \
          LLVM=1 \
          LLVM_IAS=1 \
          -j2

    - name: Clone AnyKernel3
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git

    - name: Package Kernel (AnyKernel3)
      run: |
        cp Kernel/kernel_platform/common/out/arch/arm64/boot/Image AnyKernel3/
        cd AnyKernel3
        zip -r9 KernelSU-M556B.zip ./*

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-M556B
        path: AnyKernel3/KernelSU-M556B.zip
