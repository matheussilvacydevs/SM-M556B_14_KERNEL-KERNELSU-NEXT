name: Build SM-M556B Kernel (No LTO / No HDRINST)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout kernel source (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git git-lfs bc bison flex \
            libssl-dev libelf-dev \
            build-essential \
            python3 \
            ccache

      - name: Init Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Setup environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV

      - name: Disable LTO (Vega method)
        run: |
          DEFCONFIG=Kernel/kernel_platform/msm-kernel/arch/arm64/configs/vendor/x55_defconfig
          sed -i 's/^CONFIG_LTO=y/CONFIG_LTO=n/' $DEFCONFIG || true
          sed -i 's/^CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/' $DEFCONFIG || true
          sed -i 's/^CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_THIN=n/' $DEFCONFIG || true
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_FULL=n/' $DEFCONFIG || true

      - name: Kernel defconfig
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make O=out vendor/x55_defconfig

      - name: Build kernel Image (NO HDRINST / NO LTO)
        working-directory: Kernel/kernel_platform/msm-kernel
        run: |
          make -j$(nproc) \
            O=out \
            CC=clang \
            Image

      - name: Upload kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-Image
          path: Kernel/kernel_platform/msm-kernel/out/arch/arm64/boot/Image
