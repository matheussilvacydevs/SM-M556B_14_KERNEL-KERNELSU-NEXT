name: Build SM-M556B (Native Clang + Bypass)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_TARGET: m55xq_swa_open
      CHIPSET_NAME: x55
      DEBIAN_FRONTEND: noninteractive

    steps:
    # 1Ô∏è‚É£ LIMPEZA DE DISCO
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    # 2Ô∏è‚É£ Checkout SEM LFS
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: false
        fetch-depth: 1

    # 3Ô∏è‚É£ SWAP
    - name: Setup Swap (8GB)
      run: |
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    # 4Ô∏è‚É£ Depend√™ncias (Adicionado clang e lld explicitamente)
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential cpio flex git \
          libncurses-dev libssl-dev python3 \
          unzip wget rsync dwarves lld clang llvm

    # 5Ô∏è‚É£ Export vari√°veis Samsung
    - name: Export Samsung build variables
      run: |
        echo "MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "PROJECT_NAME=$(echo $BUILD_TARGET | cut -d'_' -f1)" >> $GITHUB_ENV
        echo "ANDROID_BUILD_TOP=$PWD" >> $GITHUB_ENV
        echo "TARGET_PRODUCT=gki" >> $GITHUB_ENV
        echo "TARGET_BOARD_PLATFORM=gki" >> $GITHUB_ENV
        echo "IS_KBUILD=true" >> $GITHUB_ENV

    # 6Ô∏è‚É£ Detectar estrutura real do kernel
    - name: Detect kernel structure
      run: |
        if [ -d "Kernel/kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=Kernel/kernel_platform" >> $GITHUB_ENV
        elif [ -d "kernel_platform/build/android" ]; then
          echo "KERNEL_PATH=kernel_platform" >> $GITHUB_ENV
        else
          echo "‚ùå Estrutura n√£o encontrada"
          exit 1
        fi

    # 7Ô∏è‚É£ Build kernel (Usando Clang do Sistema)
    - name: Build Samsung GKI kernel
      run: |
        cd $KERNEL_PATH
        
        echo "üßπ Limpando travas de ABI e Config..."
        find . -name "abi_symbollist*" -delete
        find msm-kernel/arch/arm64/configs/ -name "*" -exec sed -i '/CONFIG_CFI_CLANG/d' {} +
        find msm-kernel/arch/arm64/configs/ -name "*" -exec sed -i '/CONFIG_LTO_CLANG/d' {} +
        
        chmod +x build/android/prepare_vendor.sh
        
        echo "üöÄ Iniciando compila√ß√£o com Clang nativo..."
        # For√ßamos o uso do Clang instalado no /usr/bin
        RECOMPILE_KERNEL=1 \
        SKIP_ABI_CHECKS=1 \
        SKIP_CP_METADATA=1 \
        SKIP_CONF_CHECK=1 \
        KMI_SYMBOL_LIST_STRICT_MODE=0 \
        GKI_ABI_CHECK=0 \
        CLANG_PREBUILT_BIN=true \
        REAL_CLANG_PATH=/usr/bin \
        build/android/prepare_vendor.sh $CHIPSET_NAME gki gki

    # 8Ô∏è‚É£ Empacotar
    - name: Package kernel output
      run: |
        mkdir -p artifacts
        DIST_DIR=$(find . -type d -name "dist" | grep "out" | head -n 1)
        
        if [ -n "$DIST_DIR" ]; then
            cp -r $DIST_DIR/* artifacts/
        else
            find . -name "Image" -exec cp {} artifacts/ \;
            find . -name "Image.lz4" -exec cp {} artifacts/ \;
            find . -name "*.dtb" -exec cp {} artifacts/ \;
            find . -name "dtbo.img" -exec cp {} artifacts/ \;
            find . -name "*.ko" -exec cp {} artifacts/ \;
        fi
        zip -r SM-M556B_kernel_build.zip artifacts

    # 9Ô∏è‚É£ Upload
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M556B_kernel_build
        path: SM-M556B_kernel_build.zip
